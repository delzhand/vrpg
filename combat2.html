<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script
src="https://code.jquery.com/jquery-2.2.4.min.js"
integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
<link href="./css/shared.css" rel="stylesheet">
<link href="./css/combat.css" rel="stylesheet">
<link href="./css/profile.css" rel="stylesheet">
<link href="./css/matchup.css" rel="stylesheet">
<script src="./actions.js"></script>
<script src="./gear.js"></script>
<script src="./lib.js"></script>

<script>
  class Unit {
    status = [];
    constructor(name, level, job, picture, color, team, chp, mhp, atk, def, res, spd, ct, pool, arms = null, armor = null) {
      this.name = name;
      this.level = level;
      this.job = job;
      this.picture = picture;
      this.color = color;
      this.team = team;
      this.chp = chp;
      this.mhp = mhp;
      this.atk = atk;
      this.def = def;
      this.res = res;
      this.spd = spd;
      this.ct = ct;
      this.pool = pool;
      this.xp = 0;
      this.arms = arms;
      this.armor = armor;
    }
    addStatus(status, duration) {
      this.status[status] = duration;
    }
    clearAllStatus() {
      this.status = [];
    }
    chooseAbility() {
      const r = getRandomInt(this.pool.length);
      console.log(actions[this.pool[r]]);
      return actions[this.pool[r]];
    }
    chooseFoe() {
      let foes = [];
      for (let i = 0; i < units.length; i++) {
        if (units[i].team != this.team) {
          foes.push(units[i]);
        }
      }
      return foes[getRandomInt(foes.length)];
    }
    chooseLowestHpAlly() {
      let ally = this;
      for (let i = 0; i < units.length; i++) {
        if (units[i].team && units[i].chp < this.chp) {
          ally = units[i];
        }
      }
      return ally;
    }
    tick() {
      this.ct += 12 + this.spd;
      if (this.ct >= 100) {
        const action = this.chooseAbility();
        if (this.team === 'ally' && action !== 'weapon' && action !== 'magic') {
          this.xp += 5;
        }
        try {
          action.fn(this);          
        }
        catch (e) {
          console.log(e);
        }
        this.ct -= 100;
      }
    }
    takeDamage(value) {
      this.chp -= value;
      if (this.chp <= 0) {
        this.chp = 0;
        this.clearAllStatus();
        this.addStatus('down');
      }
    }
    healDamage(value) {
      if (this.chp > 0) {
        this.chp += value;
        if (this.chp > this.mhp) {
          this.chp = this.mhp;
        }
      }
    }
    drawProfile(h = true) {
      return `
        <div class="profile ${h ? 'hz' : ''} unit-${this.name.safeCSS()}">
          ${drawPicture(this)}
          <div class="data">
            <div class="name">${this.name}</div>
            <div class="level">Lv <b>${this.level}</b> ${this.job}</div>
            ${drawMeter('HP', this.chp ? this.chp : null, this.mhp)}
            <div class="stats">
              ${this.drawStat('ATK', this.atk, this.getBonus('atk'))}
              ${this.drawStat('DEF', this.def, this.getBonus('def'))}
              ${this.drawStat('RES', this.res, this.getBonus('res'))}
              ${this.drawStat('SPD', this.spd, this.getBonus('spd'))}
            </div>
            ${this.team === 'ally' ? drawMeter('XP', this.xp, this.level * 5) : ''}
          </div>
          <div class="loadout">
            ${this.team === 'ally' ? this.drawGear() : ''}
            <div class="equip"><span class="icon attack"></span> Thrust</div>
            <div class="equip"><span class="icon attack"></span> Flank</div>
            <div class="equip"><span class="icon reaction"></span> Counter</div>
            <div class="equip"><span class="icon passive"></span> Determination</div>
          </div>
        </div>
      `;
    }
    updateProfile() {
      const $profile = $(`.unit-${this.name.safeCSS()}`);
      $profile.find('.hp .curmax .current').html(this.chp);
      $profile.find('.hp .bar .inner').css('width', this.chp/this.mhp*100 + '%')
      $profile.find('.xp .curmax .current').html(this.xp);
      $profile.find('.xp .bar .inner').css('width', this.xp/this.level*5 + '%')
    }
    getBonus(stat) {
      return 0;
    }
    drawGear(label, id) {
      return `
      <div class="equip"><span class="icon weapon"></span> ${gear[this.arms].name}</div>
      <div class="equip"><span class="icon armor"></span> ${gear[this.armor].name}</div>
      `;
    }
    drawStat(label, value, bonus) {
      return `<div class="stat"><span class="label">${label}</span><span class="num">${value}</span></div>`;
    }
  }

  const seedRand = new Math.seedrandom('');

  const units = [
    new Unit('Saoirse', 5, 'Fencer', 'surtia.jpeg', null, 'ally', 10 * 5, 10 * 5, 10, 6, 3, 6, getRandomInt(50), ['weapon', 'thrust', 'thrust', 'thrust', 'flank', 'flank'], 'estoc', 'doublet'),
    new Unit('Parzeval', 5, 'Mage', 'areval.jpeg', null, 'ally', 9 * 5, 9 * 5, 10, 6, 6, 4, getRandomInt(50), ['magic', 'ice spear', 'hailstorm'], 'frost staff', 'tunic'),
    new Unit('Garven', 5, 'Knight', 'graven.jpeg', null, 'ally', 13 * 5, 13 * 5, 4, 9, 5, 4, getRandomInt(50), ['weapon', 'crushing blow', 'crushing blow', 'protect'], 'halberd', 'chainmail'),    
    new Unit('Hanya', 5, 'Monk', 'hanya.jpeg', null, 'ally', 11 * 5, 11 * 5, 7, 5, 6, 6, getRandomInt(50), ['weapon', 'blazing fist', 'mantra'], 'tunic', 'baghnakhs'),
    new Unit('Bone Wraith', 5, 'Monster', null, '#cc4141', 'enemy', 10 * 5, 10 * 5, 8, 7, 6, 4, getRandomInt(50), ['weapon', 'weapon', 'grave dirt']),
    new Unit('Ichor', 5, 'Monster', null, '#cc4141', 'enemy', 13 * 5, 13 * 5, 6, 6, 6, 4, getRandomInt(50), ['weapon', 'weapon', 'bootslop']),
  ];
  
  function isVictory() {
    for (let i = 0; i < units.length; i++) {
      if (units[i].team === 'enemy' && units[i].chp > 0) {
        return false;
      }
    }
    return true;
  }

  function isDefeat() {
    for (let i = 0; i < units.length; i++) {
      if (units[i].team === 'ally' && units[i].chp > 0) {
        return false;
      }
    }
    return true;
  }

  function tick() {
    for (let i = 0; i < units.length; i++) {
      units[i].tick();
    }
    for (let i = 0; i < units.length; i++) {
      units[i].updateProfile();
    }
  }

  function run() {
    if (!isDefeat() && !isVictory()) {
      tick();
      if (isDefeat()) {
        console.log("Defeated");
        return;
      }
      if (isVictory()) {
        console.log("Victory");
        return;
      }
    }
  }

  function drawInit() {
    for (let i = 0; i < units.length; i++) {
      $('.profiles').append(units[i].drawProfile());
    }
  }

  function log(message) {
    $('.log').append(message);
  }

</script>
<title>V-RPG | Combat 3.0</title>
</head>
<body>

<div class="container">

  <div class="matchup ally">
    <div class="left attack">
      <div class="picture"><img src="./images/surtia.jpeg"></div>
      <div class="name">Saoirse</div>
      <div class="action"><span class="icon attack"></span> Thrust</div>
      <div class="outcomes">
        <div>22 dmg</div>
        <div>+ ATK Up</div>
      </div>
    </div>
    <div class="right counter">
      <div class="outcomes">2 dmg</div>
      <div class="action"><span class="icon reaction"></span> Counter</div>
      <div class="name">Bone Wraith</div>
      <div class="picture" style="background-color: #cc4141;"></div>
    </div>
  </div>

  <div class="matchup enemy">
    <div class="left">
      <div class="picture"><img src="./images/graven.jpeg"></div>
      <div class="name">Garven</div>
      <div class="action"><span class="icon reaction"></span> Block</div>
      <div class="outcomes">
        <div>-10% dmg</div>
      </div>
    </div>
    <div class="right">
      <div class="outcomes">0 dmg</div>
      <div class="action"><span class="icon magic"></span> Attack</div>
      <div class="name">Bone Wraith</div>
      <div class="picture" style="background-color: #cc4141;"></div>
    </div>
  </div>

  <div class="matchup ally">
    <div class="left support">
      <div class="picture"><img src="./images/hanya.jpeg"></div>
      <div class="name">Hanya</div>
      <div class="action"><span class="icon magic"></span> Mantra</div>
      <div class="outcomes">
        <div class="pos">-10 dmg</div>
      </div>
    </div>
    <div class="right">
      <div class="outcomes"></div>
      <div class="action"></div>
      <div class="name">Allies</div>
      <div class="picture" style="background-color: #4d4dff;"></div>
    </div>
  </div>

  <div class="profiles"></div>
  <div class="log"></div>
</div>
<script>
  drawInit();
  const interval = setInterval(run, 1000);
</script>
</body>
</html>