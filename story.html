<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script
src="https://code.jquery.com/jquery-2.2.4.min.js"
integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
<link href="./css/shared.css" rel="stylesheet">
<link href="./css/story.css" rel="stylesheet">
<script src="./party.js"></script>
<script src="./lib.js"></script>
<script src="./scenes.js"></script>
<script>
  q = getUrlVars();
  let scene = scenes[q.scene];
  let index = 0;
  let lines = scene.split('\n');
  let interval = null;
  
  function rescroll() {
    clearInterval(interval);
    $('.line.temp').remove();
    $('.twitter-tweet').last()[0].scrollIntoView(false);
  }

  function advance() {
    if (index > lines.length - 1) {
      return;
    }
    let line = lines[index].trim();
    if (line.length === 0) {
      index++;
      line = lines[index].trim();
    }
    line = line.split(': ');
    switch (line[0]) {
      case 'EXPO':
      case 'SCENE':
      case 'ACTION':
        $('#story').append(`<div class="line ${line[0].toLowerCase()}">${line[1]}</div>`);
        break;
      case 'MUSIC':
        let link = line[1].split('|');
        $('#story').append(`<div class="line music"><span class="inner"><span class="title">â™ª ${link[0]}</span><a href="${link[1]}" target="_blank"><img src="./images/play.svg"></a></span></div>`);
        break;
      case 'VOTE-TW':
        $('#story').append('<div class="line temp"><span class="spinner"></span></div>')
        $('#story').append(line[1]);
        interval = setInterval(rescroll, 2000);
        break;
      case 'VOTE-OPEN':
      case 'VOTE-CLOSED':
        $('#story').append(`<div class="line vote"><div class="title">${line[0]}</div></div>`);
        let options = line[1].split('|');
        for (let i = 0; i < options.length; i++) {
          const data = options[i].split('%');
          if (data.length === 2) {
            $('#story .vote').last().append(`<div class="option"><span class="num">${i + 1}</span><span class="text">${data[0].trim()}</span><span class="inner" style="width: ${data[1]}%;"></span></div>`);
          }
          else {
            $('#story .vote').last().append(`<div class="option"><span class="num">${i + 1}</span><span class="text">${options[i].trim()}</span></div>`);
          }
        }
        break;
      default:
        let spos = line[0].split('|');
        const pos = (spos[1] === 'R') ? '' : 'rev';
        const actor = actors[spos[0]];
        if (actor) {
          $('#story').append(`
            <div class="line dialog ${pos}">
              <div class="speaker">
                <div class="image"><img src="./images/${actor.picture}"></div>
                <div class="name">${actor.name}</div>
              </div>
              <div class="text">${line[1]}</div>
            </div>`);
        } else {
          $('#story').append(`
            <div class="line dialog ${pos}">
              <div class="speaker">
                <div class="name">${spos[0]}</div>
              </div>
              <div class="text">${line[1]}</div>
            </div>`);
        }
        break;
    }
    index++;
    $('.line').last()[0].scrollIntoView(false);
    if (index > lines.length - 1) {
      $('.line').last().after('<div class="scene-end"></div>');
    }
  }

</script>
<title>V-RPG | Story</title>
</head>
<body onclick="advance()">

<div class="container">
  <div id="story"></div>
</div>
<script>
  advance();
</script>
</body>
</html>