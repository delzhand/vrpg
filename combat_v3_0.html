<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script
src="https://code.jquery.com/jquery-2.2.4.min.js"
integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
<link href="./css/shared.css" rel="stylesheet">
<link href="./css/profile.css" rel="stylesheet">
<link href="./css/matchup.css" rel="stylesheet">
<link href="./css/sprite.css" rel="stylesheet">
<script src="./unit.js"></script>
<script src="./abilities.js"></script>
<script src="./gear.js"></script>

<script>
  let seedRand = null;
  let units = null;
  let queue = null;

  const input = {
    xpMultiplier: 1,
    seed: '5',
    units: [
      {
        name: 'Saoirse',
        level: 5,
        job: 'Fencer',
        picture: 'surtia.jpeg',
        team: 'ally',
        vit: 10,
        atk: 10,
        def: 6,
        res: 3,
        spd: 6,
        pool: ['weapon', 'thrust', 'thrust', 'flank'],
        abilities: ['thrust', 'flank', 'counter'],
        arms: 'estoc',
        armor: 'doublet',
        xp: 0,
      },
      {
        name: 'Parzeval',
        level: 5,
        job: 'Mage',
        picture: 'areval.jpeg',
        team: 'ally',
        vit: 9,
        atk: 10,
        def: 6,
        res: 6,
        spd: 4,
        pool: ['magic', 'ice spear', 'hailstorm'],
        abilities: ['ice spear', 'hailstorm', 'absorb'],
        arms: 'frost staff',
        armor: 'tunic',
        xp: 0,
      },
      {
        name: 'Garven',
        level: 5,
        job: 'Knight',
        picture: 'graven.jpeg',
        team: 'ally',
        vit: 13,
        atk: 5,
        def: 8,
        res: 5,
        spd: 4,
        pool: ['weapon', 'crushing blow', 'protect'],
        abilities: ['crushing blow', 'protect', 'parry'],
        arms: 'halberd',
        armor: 'chainmail',
        xp: 0,
      },
      {
        name: 'Hanya',
        level: 5,
        job: 'Monk',
        picture: 'hanya.jpeg',
        team: 'ally',
        vit: 9,
        atk: 10,
        def: 6,
        res: 6,
        spd: 4,
        pool: ['weapon', 'blazing fist', 'blazing fist', 'mantra'],
        abilities:  ['blazing fist', 'mantra', 'momentum'],
        arms: 'tunic',
        armor: 'baghnakhs',
        xp: 0,
      },
      {
        name: 'Bone Wraith',
        level: 5,
        job: 'Monster',
        team: 'enemy',
        vit: 30,
        atk: 8,
        def: 7,
        res: 5,
        spd: 4,
        pool: ['weapon', 'weapon', 'grave dirt'],
        abilities: ['grave dirt', 'counter'],
        arms: 'rusted sword'
      },
      {
        name: 'Ichor',
        level: 5,
        job: 'Monster',
        team: 'enemy',
        vit: 33,
        atk: 6,
        def: 6,
        res: 6,
        spd: 4,
        pool: ['magic', 'magic', 'bootslop'],
        abilities: ['bootslop', 'absorb'],
      }
    ]
  };

  let getCount = 0;
  function getRandomInt(max) {
    const r = Math.floor(seedRand() * max);
    return r;
  }

  function isVictory() {
    for (let i = 0; i < units.length; i++) {
      if (units[i].team === 'enemy' && units[i].chp > 0) {
        return false;
      }
    }
    return true;
  }

  function isDefeat() {
    for (let i = 0; i < units.length; i++) {
      if (units[i].team === 'ally' && units[i].chp > 0) {
        return false;
      }
    }
    return true;
  }

  function tick() {
    if (isDefeat()) {
      return;
    }
    if (isVictory()) {
      return;
    }

    for (let i = 0; i < units.length; i++) {
      if (!isDefeat() && !isVictory()) {
        units[i].tick();
      }
    }
  }

  function findUnit(name) {
    for (let i = 0; i < units.length; i++) {
      if (units[i].name === name) {
        return units[i];
      }
    }
    return false;
  }

  function fillQueue() {
    while (!isDefeat() && !isVictory()) {
      tick();
    }
    init();
  }

  function init() {
    seedRand =  new Math.seedrandom(input.seed);
    units = [];
    for (let i = 0; i < input.units.length; i++) {
      const unit = input.units[i];
      units.push(new Unit(unit.name, unit.level, unit.job, unit.picture, unit.team, unit.hp, unit.vit, unit.atk, unit.def, unit.res, unit.spd, unit.xp, unit.pool, unit.abilities, unit.arms, unit.armor));
    }
    width = $('.frame').outerWidth();
    console.log(width);
    width /= 160;
    if (width > 5) {
      width = 5;
      $('.frame').css('padding-top', '720px');
    }
    $('.visualizer').css('transform', `translateX(-50%) scale(${width})`);

  }

  function drawInit() {
    for (let i = 0; i < units.length; i++) {
      $('.profiles').append(units[i].drawProfile());
    }
  }

  function drawQueue() {
    for (let i = 0; i < queue.length; i++) {
      $('.queue').append(drawQueueItem(queue[i]));
    }
  }

  function drawQueueItem(item) {
    return `
      <div class="item">
        <div class="unit">${item.unit}</div>
        <div class="ability">${abilities[item.ability].name}</div>
      </div>
    `;
  }

  let index = 0;
  let animationLocks = 0;
  function advance() {
    $('.tap-msg').remove();
    if (index >= queue.length) {
      return;
    }
    if (animationLocks > 0) {
      return;
    }
    $('.queue .item.active').addClass('done');
    $('.queue .item.active').removeClass('active');
    $(`.queue .item:nth-child(${index+1})`).addClass('active');

    const item = queue[index];
    unit = findUnit(item.unit);
    unit.chooseAbility(); // just to increment seedrandom to match queue
    abilities[item.ability].fn(unit, true);
    unit.endRound();
    index++;
    updateAllProfiles();
    if (index >= queue.length) {
      if (isVictory()) {
        log('<div>Victory</div>');
      }
      if (isDefeat()) {
        log('<div>Defeated</div>');
      }
    }
  }

  let logIndex = 1;
  function log(message) {
    $(`.log-${logIndex}`).append(message);
  }

  function updateAllProfiles() {
    for (let i = 0; i < units.length; i++) {
      units[i].updateProfile();
    }
  }

  String.prototype.safeCSS = function() {
  return encodeURIComponent(this)
    .toLowerCase()
    .replace('\'', '')
    .replace(/\.|%[0-9a-z]{2}/gi, '');
  }

</script>
<title>V-RPG | Combat 3.0</title>
</head>
<body onclick="advance()">

<div class="container ptb">

  <div class="frame">
    <div class="visualizer">
      <div class="tap-msg">Tap!</div>
      <div class="battlefield"></div>
      <div class="saoirse sprite left" style="top: 35%;">    <div class="hp"></div><div class="image"></div></div>
      <div class="parzeval sprite left" style="top: 50%;">   <div class="hp"></div><div class="image"></div></div>
      <div class="garven sprite left" style="top: 65%;">     <div class="hp"></div><div class="image"></div></div>
      <div class="hanya sprite left" style="top: 80%;">      <div class="hp"></div><div class="image"></div></div>
      <div class="bonewraith sprite right" style="top: 40%;"><div class="hp"></div><div class="image"></div></div>
      <div class="ichor sprite right" style="top: 65%;">     <div class="hp"></div><div class="image"></div></div>
      <div class="skills"></div>
    </div>
  </div>
  <div class="queue"></div>

  <div class="profiles"></div>
  <div class="row logs">
    <div class="col col-6 log-1"></div>
    <div class="col col-6 log-2"></div>
  </div>
</div>
<script>
  queue = [];
  init();
  fillQueue();
  drawQueue();
  logIndex++;
  // drawInit();
</script>
</body>
</html>