<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script
src="https://code.jquery.com/jquery-2.2.4.min.js"
integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
<link href="./css/shared.css" rel="stylesheet">
<link href="./css/profile.css" rel="stylesheet">
<link href="./css/matchup.css" rel="stylesheet">
<link href="./css/sprite.css" rel="stylesheet">
<script src="./abilities.js"></script>
<script src="./gear.js"></script>

<script>
  let seedRand = null;
  let units = null;
  let queue = null;

  class Unit {
    constructor(name, level, job, picture, team, hp, vit, atk, def, res, spd, xp, pool, abilities, arms, armor) {
      this.name = name;
      this.job = job;
      this.level = level;
      this.xp = xp;
      this.picture = picture;
      this.team = team;
      this.color = team === 'ally' ? '#4d4dff' : '#cc4141';
      this.vit = vit;
      this.atk = atk;
      this.def = def;
      this.res = res;
      this.spd = spd;
      this.pool = pool;
      this.abilities = abilities;
      this.arms = arms;
      this.armor = armor;
      this.status = [];

      this.ct = getRandomInt(50);
      this.mhp = this.getStat('mhp');
      this.getStartHP(hp);
    }
    getStartHP(val) {
      if (val !== undefined) {
        this.chp = val;
      }
      else {
        this.chp = this.mhp;
      }
    }
    addStatus(status, duration = false) {
      let hasStatus = false;
      for (let i = 0; i < this.status.length; i++) {
        if (this.status[i].status === status) {
          this.status[i].duration = duration;
          hasStatus = true;
        }
      }
      if (!hasStatus) {
        this.status.push({status, duration});
      }
    }
    removeStatus(status) {
      for (let i = this.status.length - 1; i >= 0;  --i) {
        if (this.status[i].status === status) {
          this.status.splice(i, 1);
          return;
        }
      }
    }
    clearAllStatus() {
      this.status = [];
    }
    hasStatus(status) {
      for (let i = 0; i < this.status.length; i++) {
        if (this.status[i].status === status && (this.status[i].duration === false || this.status[i].duration > 0)) {
          return true;
        }
      }  
      return false;
    }
    react(target) {
      console.log(this.abilities);
      for (let i = 0; i < this.abilities.length; i++) {
        const ability = abilities[this.abilities[i]];
        if (ability.type === 'reaction') {
          ability.fn(this, target);
        }
      }
    }
    chooseAbility() {
      const r = getRandomInt(this.pool.length);
      return this.pool[r];
    }
    chooseFoe() {
      let foes = [];
      for (let i = 0; i < units.length; i++) {
        if (units[i].team != this.team && units[i].chp > 0) {
          foes.push(units[i]);
        }
      }
      return foes[getRandomInt(foes.length)];
    }
    chooseLowestHpAlly() {
      let ally = this;
      for (let i = 0; i < units.length; i++) {
        if (units[i].team === this.team && units[i].chp < ally.chp) {
          ally = units[i];
        }
      }
      return ally;
    }
    tick() {
      if (this.chp === 0) {
        return;
      }
      this.ct += 12 + this.getStat('spd');
      if (this.ct >= 100) {
        const ability = this.chooseAbility();
        queue.push({unit: this.name, ability});
        if (this.hasStatus('flanked')) {
          this.removeStatus('flanked');
          log(`<div>${this.name}'s action failed</div>`);
        }
        else {
          abilities[ability].fn(this);          
          if (this.team === 'ally' && ability.name !== 'weapon' && ability.name !== 'magic') {
            this.xp += 5 * input.xpMultiplier;
          }
        }
        this.endRound();
      }
    }
    mitigateDef(value) {
      for (let i = 0; i < this.status.length; i++) {
        if (this.hasStatus('shield 15')) {
          value = Math.max( value - 15, 0);
          this.removeStatus('shield 15');
        }
      }
      return value;
    }
    mitigateRes(value) {
      for (let i = 0; i < this.status.length; i++) {
        if (this.hasStatus('shield 15')) {
          value = Math.max( value - 15, 0);
          this.removeStatus('shield 15');
        }
      }
      return value;
    }
    takeDamage(value) {
      this.chp -= value;
      if (this.chp <= 0) {
        this.chp = 0;
        this.clearAllStatus();
        this.addStatus('down');
      }
    }
    healDamage(value) {
      if (this.chp > 0) {
        this.chp += value;
        if (this.chp > this.mhp) {
          this.chp = this.mhp;
        }
      }
    }
    drawProfile(h = false) {
      return `
        <div class="profile ${h ? 'hz' : ''} unit-${this.name.safeCSS()}">
          ${this.drawPicture()}
          <div class="data">
            <div class="name">${this.name}</div>
            <div class="level">Lv <b>${this.level}</b> ${this.job}</div>
            ${this.drawMeter('HP', this.chp ? this.chp : null, this.mhp)}
            ${/*this.drawMeter('CT', this.ct, 100)*/ ''}
            <div class="stats">
              ${this.drawStat('atk')}
              ${this.drawStat('def')}
              ${this.drawStat('res')}
              ${this.drawStat('spd')}
            </div>
            ${this.team === 'ally' ? this.drawMeter('XP', this.xp, this.level * 5) : ''}
          </div>
          <div class="loadout">
            ${this.drawGear()}
            ${this.drawSkills()}
          </div>
          <div class="status"></div>
        </div>
      `;
    }
    endRound() {
      this.ct -= 100;
      this.xp += 5 * input.xpMultiplier;
      this.statusFalloff();
    }
    statusFalloff() {
      for (let i = this.status.length - 1; i >= 0;  --i) {
        if (this.status[i].duration !== false && this.status[i].duration !== false) {
          this.status[i].duration--;
          if (this.status[i].duration <= 0) {
            this.status.splice(i, 1);
          }
        }
      }
    }
    updateProfile() {
      const $profile = $(`.unit-${this.name.safeCSS()}`);
      if (this.chp === 0) {
        $profile.addClass('down');
      }
      $profile.find('.atk').replaceWith(this.drawStat('atk'));
      $profile.find('.def').replaceWith(this.drawStat('def'));
      $profile.find('.res').replaceWith(this.drawStat('res'));
      $profile.find('.spd').replaceWith(this.drawStat('spd'));
      $profile.find('.hp .curmax .current').html(this.chp);
      $profile.find('.hp .bar .inner').css('width', this.chp/this.mhp*100 + '%')
      $profile.find('.xp .curmax .current').html(this.xp);
      $profile.find('.xp .bar .inner').css('width', Math.min(this.xp/(this.level*5)*100, 100) + '%')
      $profile.find('.ct .curmax .current').html(this.ct);
      $profile.find('.ct .bar .inner').css('width', Math.min(this.ct, 100) + '%');
      $profile.find('.status').replaceWith(this.drawStatus());
    }
    getStat(stat) {
      if (stat === 'mhp') {
        return this['vit'] * 5 + this.getBonus(stat);
      }
      return this[stat] + this.getBonus(stat);
    }
    getBonus(stat) {
      let bonus = 0;
      bonus += this.arms && gear[this.arms][stat] ? gear[this.arms][stat] : 0;
      bonus += this.armor && gear[this.armor][stat] ? gear[this.armor][stat] : 0;
      if (stat === 'spd' && this.hasStatus('spd -1')) {
        bonus -= 1;
      }
      if (stat === 'spd' && this.hasStatus('spd +1')) {
        bonus += 1;
      }
      if (stat === 'spd' && this.hasStatus('spd +2')) {
        bonus += 2;
      }
      if (stat === 'spd' && this.hasStatus('spd +3')) {
        bonus += 3;
      }
      if (stat === 'atk' && this.hasStatus('atk -2')) {
        bonus -= 2;
      }
      if (stat === 'atk' && this.hasStatus('atk -1')) {
        bonus -= 1;
      }
      if (stat === 'atk' && this.hasStatus('atk +1')) {
        bonus += 1;
      }
      if (stat === 'res' && this.hasStatus('res +1')) {
        bonus += 1;
      }
      if (stat === 'res' && this.hasStatus('res +2')) {
        bonus += 2;
      }
      if (stat === 'res' && this.hasStatus('res +3')) {
        bonus += 3;
      }
      return bonus;
    }
    drawPicture() {
      if (this.picture) {
        return `<div class="picture"><img src="./images/${this.picture}"></div>`;
      }
      else {
        return `<div class="picture" style="background-color: ${this.color};"></div>`
      }
    }
    drawGear() {
      let output = '';
      if (this.arms) {
        output += `<div class="equip"><span class="icon weapon"></span> ${gear[this.arms].name}</div>`;
      }
      if (this.armor) {
        output += `<div class="equip"><span class="icon weapon"></span> ${gear[this.armor].name}</div>`;
      }
      return output;
    }
    drawSkills() {
      let output = '';
      for (let i = 0; i < this.abilities.length; i++) {
        const ability = abilities[this.abilities[i]];
        output += `<div class="equip"><span class="icon ${ability.type}"></span> ${ability.name}</div>`
      }
      return output;
    }
    drawStat(stat) {
      return `<div class="stat ${stat}"><span class="label">${stat.toUpperCase()}</span><span class="num">${this[stat]}${this.drawBonus(this.getBonus(stat))}</span></div>`;
    }
    drawBonus(value) {
      if (value > 0) {
        return `<span class="bonus pos">+${value}</span>`;
      }
      if (value < 0) {
        return `<span class="bonus neg">${value}</span>`;
      }
      return '';
    }
    drawMeter(label, c, m) {
      if (c === undefined) {
        return '';
      }
      if (c === null) {
        c = m;
      }
      return `
      <div class="meter ${label.safeCSS()}">
        <div class="label">${label}</div>
        <div class="bar">
          <span class="inner" style="width: ${c / m * 100}%"></span>
          <span class="inner alt" style="width: ${c / m * 100}%"></span>
        </div>
        <div class="curmax">
          <span class="current">${c}</span>/<span class="max">${m}</span>
        </div>
      </div>
    `;
    }
    drawStatus() {
      if (!this.status || this.status.length === 0) {
        return '<div class="status"></div>';
      }
      let output = '<div class="status">';
      for (let i = 0; i < this.status.length; i++) {
        output += `<span class="effect">${this.status[i].status}</span>`;
      }
      output += '</div>';
      return output;
    }
  }

  const input = {
    xpMultiplier: 1,
    seed: '5',
    units: [
      {
        name: 'Saoirse',
        level: 5,
        job: 'Fencer',
        picture: 'surtia.jpeg',
        team: 'ally',
        vit: 10,
        atk: 10,
        def: 6,
        res: 3,
        spd: 6,
        pool: ['weapon', 'thrust', 'thrust', 'flank'],
        abilities: ['thrust', 'flank', 'counter'],
        arms: 'estoc',
        armor: 'doublet',
        xp: 0,
        hp: 25,
      },
      {
        name: 'Parzeval',
        level: 5,
        job: 'Mage',
        picture: 'areval.jpeg',
        team: 'ally',
        vit: 9,
        atk: 10,
        def: 6,
        res: 6,
        spd: 4,
        pool: ['magic', 'ice spear', 'hailstorm'],
        abilities: ['ice spear', 'hailstorm', 'absorb'],
        arms: 'frost staff',
        armor: 'tunic',
        xp: 0,
      },
      {
        name: 'Garven',
        level: 5,
        job: 'Knight',
        picture: 'graven.jpeg',
        team: 'ally',
        vit: 13,
        atk: 5,
        def: 8,
        res: 5,
        spd: 4,
        pool: ['weapon', 'crushing blow', 'protect'],
        abilities: ['crushing blow', 'protect', 'parry'],
        arms: 'halberd',
        armor: 'chainmail',
        xp: 0,
      },
      {
        name: 'Hanya',
        level: 5,
        job: 'Monk',
        picture: 'hanya.jpeg',
        team: 'ally',
        vit: 9,
        atk: 10,
        def: 6,
        res: 6,
        spd: 4,
        pool: ['weapon', 'blazing fist', 'blazing fist', 'mantra'],
        abilities:  ['blazing fist', 'mantra', 'momentum'],
        arms: 'tunic',
        armor: 'baghnakhs',
        xp: 0,
      },
      {
        name: 'Bone Wraith',
        level: 5,
        job: 'Monster',
        team: 'enemy',
        vit: 30,
        atk: 8,
        def: 7,
        res: 5,
        spd: 4,
        pool: ['weapon', 'weapon', 'grave dirt'],
        abilities: ['grave dirt', 'counter'],
        arms: 'rusted sword'
      },
      {
        name: 'Ichor',
        level: 5,
        job: 'Monster',
        team: 'enemy',
        vit: 33,
        atk: 6,
        def: 6,
        res: 6,
        spd: 4,
        pool: ['magic', 'magic', 'bootslop'],
        abilities: ['bootslop', 'absorb'],
      }
    ]
  };

  let getCount = 0;
  function getRandomInt(max) {
    const r = Math.floor(seedRand() * max);
    return r;
  }

  function isVictory() {
    for (let i = 0; i < units.length; i++) {
      if (units[i].team === 'enemy' && units[i].chp > 0) {
        return false;
      }
    }
    return true;
  }

  function isDefeat() {
    for (let i = 0; i < units.length; i++) {
      if (units[i].team === 'ally' && units[i].chp > 0) {
        return false;
      }
    }
    return true;
  }

  function tick() {
    if (isDefeat()) {
      return;
    }
    if (isVictory()) {
      return;
    }

    for (let i = 0; i < units.length; i++) {
      if (!isDefeat() && !isVictory()) {
        units[i].tick();
      }
    }
  }

  function findUnit(name) {
    for (let i = 0; i < units.length; i++) {
      if (units[i].name === name) {
        return units[i];
      }
    }
    return false;
  }

  function fillQueue() {
    while (!isDefeat() && !isVictory()) {
      tick();
    }
    init();
  }

  function init() {
    seedRand =  new Math.seedrandom(input.seed);
    units = [];
    for (let i = 0; i < input.units.length; i++) {
      const unit = input.units[i];
      units.push(new Unit(unit.name, unit.level, unit.job, unit.picture, unit.team, unit.hp, unit.vit, unit.atk, unit.def, unit.res, unit.spd, unit.xp, unit.pool, unit.abilities, unit.arms, unit.armor));
    }
  }

  function drawInit() {
    for (let i = 0; i < units.length; i++) {
      $('.profiles').append(units[i].drawProfile());
    }
  }

  function drawQueue() {
    for (let i = 0; i < queue.length; i++) {
      $('.queue').append(drawQueueItem(queue[i]));
    }
  }

  function drawQueueItem(item) {
    return `
      <div class="item">
        <div class="unit">${item.unit}</div>
        <div class="ability">${abilities[item.ability].name}</div>
      </div>
    `;
  }

  let index = 0;
  function advance() {
    if (index >= queue.length) {
      return;
    }
    $('.queue .item.active').addClass('done');
    $('.queue .item.active').removeClass('active');
    $(`.queue .item:nth-child(${index+1})`).addClass('active');

    const item = queue[index];
    unit = findUnit(item.unit);
    unit.chooseAbility(); // just to increment seedrandom to match queue
    abilities[item.ability].fn(unit);
    unit.endRound();
    index++;
    updateAllProfiles();
    if (index >= queue.length) {
      if (isVictory()) {
        log('<div>Victory</div>');
      }
      if (isDefeat()) {
        log('<div>Defeated</div>');
      }
    }
  }

  let logIndex = 1;
  function log(message) {
    $(`.log-${logIndex}`).append(message);
  }

  function updateAllProfiles() {
    for (let i = 0; i < units.length; i++) {
      units[i].updateProfile();
    }
  }

  String.prototype.safeCSS = function() {
  return encodeURIComponent(this)
    .toLowerCase()
    .replace('\'', '')
    .replace(/\.|%[0-9a-z]{2}/gi, '');
  }

</script>
<title>V-RPG | Combat 3.0</title>
</head>
<body onclick="advance()">

<div class="container">

  <!-- <div class="matchup ally">
    <div class="left attack">
      <div class="picture"><img src="./images/surtia.jpeg"></div>
      <div class="name">Saoirse</div>
      <div class="action"><span class="icon attack"></span> Thrust</div>
      <div class="outcomes">
        <div>22 dmg</div>
        <div>+ ATK Up</div>
      </div>
    </div>
    <div class="right counter">
      <div class="outcomes">2 dmg</div>
      <div class="action"><span class="icon reaction"></span> Counter</div>
      <div class="name">Bone Wraith</div>
      <div class="picture" style="background-color: #cc4141;"></div>
    </div>
  </div>

  <div class="matchup enemy">
    <div class="left">
      <div class="picture"><img src="./images/graven.jpeg"></div>
      <div class="name">Garven</div>
      <div class="action"><span class="icon reaction"></span> Block</div>
      <div class="outcomes">
        <div>-10% dmg</div>
      </div>
    </div>
    <div class="right">
      <div class="outcomes">0 dmg</div>
      <div class="action"><span class="icon magic"></span> Attack</div>
      <div class="name">Bone Wraith</div>
      <div class="picture" style="background-color: #cc4141;"></div>
    </div>
  </div>

  <div class="matchup ally">
    <div class="left support">
      <div class="picture"><img src="./images/hanya.jpeg"></div>
      <div class="name">Hanya</div>
      <div class="action"><span class="icon magic"></span> Mantra</div>
      <div class="outcomes">
        <div class="pos">-10 dmg</div>
      </div>
    </div>
    <div class="right">
      <div class="outcomes"></div>
      <div class="action"></div>
      <div class="name">Allies</div>
      <div class="picture" style="background-color: #4d4dff;"></div>
    </div>
  </div> -->

  <div class="queue"></div>
  <div class="visualizer">
    <div class="battlefield"></div>
    <div class="sprite left"><div class="image"></div></div>
    <div class="sprite right"><div class="image"></div></div>
  </div>

  <div class="profiles"></div>
  <div class="row logs">
    <div class="col col-6 log-1"></div>
    <div class="col col-6 log-2"></div>
  </div>
</div>
<script>
  queue = [];
  init();
  fillQueue();
  drawQueue();
  logIndex++;
  drawInit();
</script>
</body>
</html>